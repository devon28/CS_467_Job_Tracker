{% extends "base.html" %}

{% block content %}
    <div class="table-container">
    <h2 class="page-header">Jobs</h2>

    <table class="data-table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Salary</th>
                <th>Skills</th>
                <th>Start Date</th>
                <th>Contact</th>
                <th>Edit</th>
                <th>Delete</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <form action="/saveJobEdit" method="post" enctype="multipart/form-data">
                    <!-- Add a hidden input field for index -->
                    <input type="hidden" name="index" value="{{ index }}">
                    <td><input type="text" class="input-box" name="title" value="{{ job.title }}" placeholder="{{ job.title }}"></td>
                    <td><input type="text" class="input-box" name="salary" value="{{ job.salary }}" placeholder="{{ job.salary }}"></td>
                    
                    <td>
                        <input type="text" class="input-box" name="skills" value="" id="item-input" oninput="updateDropDown(this.value)">

    <div id="suggested-items-container"></div>
    <div id="selected-items-wrapper">
        <div id="selected-items-container">
            <!-- Render the selected items here -->
            {% for item in job_skills %}
            <div class="selected-item">
                <button class="remove-item-button" onclick="removeItem('{{ item }}')">x</button>
                <span>{{ item }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</td>

                    <td><input type="text" class="input-box" name="start_date" value="{{ job.start_date }}" placeholder="{{ job.start_date }}"></td>
                    <td><input type="text" class="input-box" name="contact" value="{{ job.contact }}" placeholder="{{ job.contact }}"></td>
                    <td><button type="submit" class="save-button">Save</button></td>
                    <td><button class="cancel-button" onclick="refreshPage()">Cancel</button></td>
                </form>
                
            </tr>
            
        </tbody>
    </table>

    <script>

window.addEventListener("DOMContentLoaded", function () {
    document.getElementById("item-input").removeAttribute("placeholder");
    document.getElementById("item-input").setAttribute("type", "hidden");
    document.getElementById("item-input").value = selectedItems.join(", ");
  });
    
    function saveJob() {
    // Get the form data
    const formElements = document.querySelectorAll("tbody tr:first-child input");
    const formData = new FormData();

    formElements.forEach(input => {
        const placeholder = input.getAttribute("placeholder");
        const value = input.value || input.getAttribute("placeholder");
        formData.append(placeholder, value);
    });

    // Remove duplicates from selectedItems array (if any)
    const uniqueSelectedItems = [...new Set(selectedItems)];

    // Convert the selectedItems array to a JSON string
    const skillsValue = JSON.stringify(uniqueSelectedItems);

    // Update the skills key with the JSON string representation of selectedItems
    if (uniqueSelectedItems.length > 0) {
        formData.set("skills", skillsValue);
    } else {
        formData.delete("skills");
    }

    // Send the form data to the /saveJobEdit route
    fetch("/saveJobEdit", {
        method: "POST",
        body: formData,
    })
    .then(response => response.json())
    .then(data => {
        console.log("Job saved successfully:");
        // Redirect to the /jobs route after saving the job
        window.location.href = "{{ url_for('jobs') }}";
    })
    .catch(error => {
        console.error("Error saving job:", error);
    });
}

function displaySelectedItems() {
    const selectedItemsContainer = document.getElementById("selected-items-container");
    selectedItemsContainer.innerHTML = selectedItems.map(item => `
        <div class="selected-item">
            <button class="remove-item-button" id='removeItemButton' onclick="removeItem('${item}')">x</button>
            <span>${item}</span>
        </div>
    `).join('');

    // Convert the selectedItems array to a JSON string
    const skillsValue = JSON.stringify(selectedItems);
    // Update the input value with the updated selectedItems array
    document.getElementById("item-input").value = skillsValue;
}

function removeItem(item) {
    // Remove the item from the selectedItems array
    selectedItems = selectedItems.filter(selectedItem => selectedItem !== item);
    // Display the updated list of selected items in the DOM
    displaySelectedItems();
    // Convert the selectedItems array to a JSON string
    const skillsValue = JSON.stringify(selectedItems);
    // Update the input value with the updated selectedItems array
    document.getElementById("item-input").value = skillsValue;
}




    function refreshPage() {
            window.location.href = "{{ url_for('jobs') }}";
    }

    // Attach the event listener to the form submit event
    document.querySelector("form").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent the default form submission
        saveJob(); // Call the saveJob() function to handle the form submission
    });

    function refreshPage() {
            window.location.href = "{{ url_for('jobs') }}";
    }
    
    
    let selectedItems = {{ job_skills | safe }};

    displaySelectedItems();

        // Attach the oninput event to the input element
        document.getElementById("item-input").addEventListener("input", function () {
            updateDropDown(this.value);
        });

        function updateDropDown(enteredText) {
    const suggestedItemsContainer = document.getElementById("suggested-items-container");
    const inputBox = document.getElementById("item-input");

    if (enteredText) {
        // If the user has typed something, show the suggested items and update the options
        suggestedItemsContainer.style.display = "block";
        updateSuggestedItems(enteredText);
    } else {
        // If the user has cleared the input, hide the suggested items
        suggestedItemsContainer.style.display = "none";
    }
}


    
        function updateSuggestedItems(enteredText) {
            const suggestedItemsContainer = document.getElementById("suggested-items-container");
            const filteredItems = items.filter(item => item.toLowerCase().includes(enteredText.toLowerCase()));
            const maxSuggestions = 3; // Limit the suggestions to 3
            const optionsHTML = filteredItems.slice(0, maxSuggestions).map(item => {
                return `<div class="suggested-item" onclick="addItemToSelectedItems('${item}')">${item}</div>`;
            }).join('');
            suggestedItemsContainer.innerHTML = optionsHTML;
        }

        function addItemToSelectedItems(item) {
    // Add the item to the selectedItems array
    selectedItems.push(item);
    // Clear the input
    document.getElementById("item-input").value = "";
    // Hide the suggested items
    const suggestedItemsContainer = document.getElementById("suggested-items-container");
    suggestedItemsContainer.style.display = "none";
    // Display the selected items
    displaySelectedItems();
}






    </script>

{% endblock %}